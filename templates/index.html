<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DisastraBot ü§ñ - Your Friend In Disaster Situation ü§ù</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <div class="chat-wrapper">
<div id="historyPanel" class="history-panel hidden">
  <div id="historyContent"></div>
    </div>
    <div class="chat-header">
      <span>DisastraBot ü§ñ - Your Friend In Disaster Situation ü§ù</span>
      <div class="chat-header-tools">
        <button class="header-btn" onclick="refreshChat()" title="Refresh chat">
          <i class="fas fa-rotate-right"></i>
        </button>
        <button class="header-btn" onclick="toggleMenu()" title="More options">
          <i class="fas fa-ellipsis-v"></i>
        </button>
      </div>
     
    </div>
    <div class="chat-box" id="chatbox">
      <div class="chat-tools-bottom"></div>
      <div class="message bot">
        <p>Hello! I'm DisastraBot, your disaster assistance companion. I'm here to help you with emergency information, safety tips, and disaster preparedness. How can I assist you today?</p>
      </div>
    </div>
    <div class="chat-input">
      <label for="language" class="sr-only">Select Language</label>
      <select id="language" title="Select your preferred language" aria-label="Language selection">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
        <option value="bn">Bengali</option>
        <option value="ta">Tamil</option>
        <option value="te">Telugu</option>
        <option value="mr">Marathi</option>
        <option value="gu">Gujarati</option>
        <option value="kn">Kannada</option>
        <option value="ml">Malayalam</option>
        <option value="or">Odia</option>
        <option value="pa">Punjabi</option>
        <option value="as">Assamese</option>
        <option value="ur">Urdu</option>
      </select>
      <label for="userInput" class="sr-only">Type your message</label>
      <input type="text" id="userInput" placeholder="Ask your question..." rows="1" aria-label="Type your message here" />
      <button id="sendBtn" title="Send your message">
        <svg xmlns="http://www.w3.org/2000/svg" class="send-icon" viewBox="0 0 24 24" fill="currentColor">
          <path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/>
        </svg>
      </button>
    </div>
  </div>
<script>
let isSending = false;
let isFollowUp = false;
let conversationHistory = [];
let pendingFollowUp = null;
let lastFollowUpText = null;

document.getElementById("sendBtn").addEventListener("click", () => sendMessage());
document.getElementById("userInput").addEventListener("keydown", function (e) {
  if (e.key === "Enter") {
    e.preventDefault();
    sendMessage();
  }
});

async function sendMessage(messageOverride = null) {
  if (isSending) return;

  const input = document.getElementById("userInput");
  const chatbox = document.getElementById("chatbox");
  const langEl = document.getElementById("language");
  const lang = langEl ? langEl.value : "en";
  const message = messageOverride || input.value.trim();
  const normalized = message.toLowerCase();

  if (!message) return;

  const affirmatives = ["yes", "okay", "sure", "ok", "yep", "yeah"];
  const negatives = ["no", "not now", "maybe later", "nah", "nope", "cancel"];

  if (affirmatives.includes(normalized)) {
    const studentHTML = `<div class="message student"><span class="student-text">${message}</span></div>`;
    chatbox.insertAdjacentHTML("beforeend", studentHTML);

    conversationHistory.push({
      role: "student",
      text: message,
      time: new Date().toLocaleTimeString()
    });

    input.value = '';
    chatbox.scrollTop = chatbox.scrollHeight;

    if (lastFollowUpText) {
      isFollowUp = true;
      setTimeout(() => handleFollowUp(lastFollowUpText), 100);
    } else {
      const botHTML = `
        <div class="message bot">
          <p>Thanks for confirming. Let me know if you need help with anything else.</p>
        </div>
      `;
      chatbox.insertAdjacentHTML("beforeend", botHTML);
    }

    return;
  }

  if (negatives.includes(normalized)) {
    const studentHTML = `<div class="message student"><span class="student-text">${message}</span></div>`;
    chatbox.insertAdjacentHTML("beforeend", studentHTML);

    const botHTML = `
      <div class="message bot">
        <p>Thanks for your response. Feel free to ask me anything else.</p>
      </div>
    `;
    chatbox.insertAdjacentHTML("beforeend", botHTML);

    input.value = '';
    chatbox.scrollTop = chatbox.scrollHeight;
    return;
  }

  const studentHTML = isFollowUp
    ? `<div class="message student follow-up"><span class="student-text">${message}</span></div>`
    : `<div class="message student"><span class="student-text">${message}</span></div>`;
  chatbox.insertAdjacentHTML("beforeend", studentHTML);
  isFollowUp = false;

  conversationHistory.push({
    role: "student",
    text: message,
    time: new Date().toLocaleTimeString()
  });

  input.value = '';
  chatbox.scrollTop = chatbox.scrollHeight;

  try {
    isSending = true;
    document.getElementById("sendBtn").disabled = true;

    const res = await fetch("/chat", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: message, language: lang })
    });

    if (!res.ok) {
      if (!chatbox.innerHTML.includes("‚ö†Ô∏è I'm having trouble connecting")) {
        chatbox.insertAdjacentHTML("beforeend", `<div class="message bot"><p>‚ö†Ô∏è I'm having trouble connecting. Please try again later.</p></div>`);
      }
      throw new Error(`HTTP error! status: ${res.status}`);
    }

    const data = await res.json();
    console.log("Backend response:", data);

    if (data.response) {
      const lines = data.response.split("\n").filter(line => line.trim());
      let botHTML = `<div class="message bot">`;
      botHTML += lines.length > 1
        ? `<ul>${lines.map(line => `<li>${line}</li>`).join("")}</ul>`
        : `<p>${lines[0]}</p>`;
      botHTML += `</div>`;
      chatbox.insertAdjacentHTML("beforeend", botHTML);

      conversationHistory.push({
        role: "bot",
        text: data.response,
        time: new Date().toLocaleTimeString()
      });
    }

    if (data.followup) {
      renderFollowUp(data.followup);
      pendingFollowUp = true;
      lastFollowUpText = data.followup;
    }

  } catch (error) {
    console.error("Fetch error:", error);
  } finally {
    isSending = false;
    document.getElementById("sendBtn").disabled = false;
    chatbox.scrollTop = chatbox.scrollHeight;
  }
}

function renderFollowUp(text) {
  const chatbox = document.getElementById("chatbox");
  const followUpHTML = `
    <div class="message bot follow-up">
      <p><b>üí°</b> <span class="clickable" onclick="handleFollowUp(this.innerText)">${text}</span></p>
    </div>
  `;
  chatbox.insertAdjacentHTML("beforeend", followUpHTML);
  lastFollowUpText = text;
}
function handleFollowUp(text) {
  let isFollowUp = true;
  const introPhrases = [
    "Great! Let‚Äôs take the next step together.",
    "I‚Äôm here with you. Want to keep going?",
    "Let‚Äôs make this simple and clear together.",
    "Here‚Äôs something that might really help.",
    "Want to explore this a bit more?",
    "Can I show you something helpful?",
    "Let me walk you through this.",
    "You‚Äôre on the right track. Want to go deeper?",
    "Let‚Äôs make this easier together.",
    "I‚Äôve got something useful for you.",
    "Shall we dive into the next part?",
    "Let‚Äôs stay safe and smart. Want to hear more?",
    "I‚Äôve got your back. Want to take a closer look?",
    "This might be useful ‚Äî shall we explore it?",
    "Let‚Äôs walk through it step by step.",
    "Here‚Äôs something that could make things clearer.",
    "I‚Äôve got a tip that might make this easier.",
    "You're doing great ‚Äî ready for the next tip?",
    "Let‚Äôs take this one step further."
  ];

  
  let cleaned = text;
  introPhrases.forEach(phrase => {
    const rx = new RegExp("^" + phrase.replace(/[.*+?^${}()|[\]\\]/g, "\\$&"), "i");
    cleaned = cleaned.replace(rx, "").trim();
  });

  
  const offerPatterns = [
    
    /\b(Can|May|Shall|Should|Would|Will|what|sign)\s+I\s+(share|give|guide|show|help|offer|should|tell|explain|make|like)\s+you\b/i,
    
    /\bCan I help you\b/i,
    /\bcan I show you\b/i,
    /\bcan I share you\b/i,
    /\bcan I guide you\b/i,
     /\bMay I help you\b/i,
      /\bMay share you\b/i,
    /\bwould like to help you\b/i,
    /\bwill like to help you\b/i,
     /\bwhat signs tell you\b/i,
     /\bwhat signs tell you\b/i,
     /\bwhat should you do if you're\b/i,
    
    /\bLet me\b/i,
    /\bI have\b.*\byou\b/i
  ];

  const isOffer = offerPatterns.some(rx => rx.test(cleaned));

  if (isOffer) {
    
    cleaned = cleaned
      .replace(/\bCan I help you\b/gi, "Can you help me")
      .replace(/\bCan I show you\b/gi, "Can you show me")
      .replace(/\bCan I guide you\b/gi, "Can you guide me")
      .replace(/\bMay I share you\b/gi, "May you share me")
      .replace(/\bMay I help you\b/gi, "May you help me")
      .replace(/\bwould like to help you\b/gi, "would you like to help me")
      .replace(/\bwill like to help you\b/gi, "will you like to help me")
      .replace(/\bWhat signs tell you\b/gi, "what signs tell me")
      .replace(/\bWhat should you do if you're\b/gi, "what should I do if I'am")

    cleaned = cleaned
      .replace(/\bI\b/g, "you")
      .replace(/\bmy\b/g, "your")
      .replace(/\bMy\b/g, "Your")
      .replace(/\byour\b/g, "my")
      .replace(/\bYour\b/g, "My")
      .replace(/\bwe\b/g, "we")
      .replace(/\byourself\b/g, "myself")
      .replace(/\bmyself\b/g, "yourself")
      .replace(/\byou're\b/g, "I'am")
      .replace(/\byou've\b/g, "I've")
      .replace(/\byou're\b/g, "I'am")
      .replace(/\byou'll\b/g, "I'll");
      
      
  } else {
    
    cleaned = cleaned
      .replace(/\bCan you\b/gi, "Can I")
      .replace(/\bMay you\b/gi, "May I")
      .replace(/\bShall you\b/gi, "Shall I")
      .replace(/\bshould you\b/gi, "should I")
      .replace(/\bWould you\b/gi, "Would I")
      .replace(/\bI\b/g, "you")
      .replace(/\byou\b/g, "I")
      .replace(/\bYou\b/g, "I")
      .replace(/\bme\b/g, "me")
      .replace(/\byour\b/g, "my")
      .replace(/\bYour\b/g, "My")
      .replace(/\bwe\b/g, "we")
      .replace(/\byourself\b/g, "myself")
      .replace(/\bmyself\b/g, "yourself")
      .replace(/\byou're\b/g, "I'am")
      .replace(/\byou've\b/g, "I've");
            
  }
  
  sendMessage(cleaned);
}


function refreshChat() {
    const chatbox = document.getElementById("chatbox");
    chatbox.innerHTML = `
      <div class="message bot">
        <p>Hello! I'm DisastraBot, your disaster assistance companion. I'm here to help you with emergency information, safety tips, and disaster preparedness. How can I assist you today?</p>
      </div>
    `;
    document.getElementById("userInput").value = '';
    conversationHistory = [];
    pendingFollowUp = null;
  }

  function toggleMenu() {
    document.getElementById("toggleMenu").classList.toggle("hidden");
  }

  document.getElementById("userInput").addEventListener("keydown", function(event) {
    if (event.key === "Enter") {
      event.preventDefault();
      sendMessage();
    }
  });
</script>

</body>
</html>